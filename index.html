<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visitor Information</title>
    <style>
      body {
        font-family: sans-serif;
        line-height: 1.6;
      }
      #info div {
        margin-bottom: 8px;
        word-wrap: break-word;
      }
      strong {
        display: inline-block;
        min-width: 150px;
      }
      button {
        margin-top: 15px;
        padding: 8px 15px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Visitor Information</h1>
    <div id="info">Loading...</div>
    <button id="saveButton" disabled>Save Data as all.txt</button>

    <script>
      let collectedData = null; // To store the data once collected

      async function getVisitorInfo() {
        const infoDiv = document.getElementById("info");
        const saveButton = document.getElementById("saveButton");
        let infoHTML = "";
        let ipAddress = "Could not fetch IP";

        const data = {}; // Object to hold the key-value pairs

        // --- Fetch IP Address ---
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const ipData = await response.json();
          ipAddress = ipData.ip;
        } catch (error) {
          console.error("Error fetching IP address:", error);
          ipAddress = `Error fetching IP: ${error.message}`;
        }
        data["IP Address"] = ipAddress;

        // --- Gather Browser Information ---
        data["User Agent"] = navigator.userAgent;
        data["Screen Resolution"] = `${screen.width}x${screen.height}`;
        data["Color Depth"] = `${screen.colorDepth}-bit`;
        data["Browser Window Size"] = `${window.innerWidth}x${window.innerHeight}`;
        data["Language"] = navigator.language || navigator.userLanguage;
        data["Platform"] = navigator.platform;
        data["Timezone"] = Intl.DateTimeFormat().resolvedOptions().timeZone;
        data["Cookies Enabled"] = navigator.cookieEnabled;
        data["Online Status"] = navigator.onLine;

        // --- Basic Device Type Inference ---
        let deviceType = "Desktop";
        if (/Mobi|Android/i.test(data["User Agent"])) {
          deviceType = "Mobile";
        } else if (/Tablet|iPad/i.test(data["User Agent"])) {
          deviceType = "Tablet";
        }
        data["Inferred Device Type"] = deviceType;

        // --- Display Information ---
        for (const key in data) {
          infoHTML += `<div><strong>${key}:</strong> ${data[key]}</div>`;
        }
        infoDiv.innerHTML = infoHTML;

        // Store collected data and enable the button
        collectedData = data;
        saveButton.disabled = false;
      }

      // Helper function to escape values for CSV if they contain commas or quotes
      function escapeCsvValue(value) {
        const stringValue = String(value); // Ensure it's a string
        // Check if the value contains a comma, a double quote, or a newline
        if (
          stringValue.includes(",") ||
          stringValue.includes('"') ||
          stringValue.includes("\n")
        ) {
          // Escape existing double quotes by doubling them
          const escapedValue = stringValue.replace(/"/g, '""');
          // Enclose the entire value in double quotes
          return `"${escapedValue}"`;
        }
        // If no special characters, return as is
        return stringValue;
      }

      function saveDataToFile() {
        if (!collectedData) {
          alert("Data not collected yet.");
          return;
        }

        // 1. Define filename and MIME type
        const filename = "all.txt";
        // Use text/plain for .txt file, though text/csv is more specific for CSV data
        const mimeType = "text/plain";

        // 2. Format data as CSV
        const headers = Object.keys(collectedData);
        const values = headers.map((header) =>
          escapeCsvValue(collectedData[header])
        ); // Escape each value

        const csvHeader = headers.join(",");
        const csvValues = values.join(",");
        const csvString = `${csvHeader}\n${csvValues}`; // Combine header and values with a newline

        // 3. Create a Blob
        const blob = new Blob([csvString], { type: mimeType });

        // 4. Create an Object URL
        const url = URL.createObjectURL(blob);

        // 5. Create a Link Element
        const link = document.createElement("a");

        // 6. Set Attributes
        link.href = url;
        link.download = filename; // Set the desired filename here

        // 7. Append, Trigger Click, Remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // 8. Clean Up Object URL
        URL.revokeObjectURL(url);
      }

      // Run the info gathering function when the page loads
      window.addEventListener("load", getVisitorInfo);

      // Add event listener to the save button
      document
        .getElementById("saveButton")
        .addEventListener("click", saveDataToFile);
    </script>
  </body>
</html>
